<%- include('../layouts/userheader') %>

<script>
  // Make variants available in the browser JS
  const variants = <%- JSON.stringify(singleData.variants || []) %>;
  const productId = "<%= singleData._id %>";
  const bestOffer = <%= Math.max(singleData.offerPercentage || 0, singleData.category?.offerPercentage || 0) %>;
</script>

<%
  // -------- DEFAULT VARIANT (first in-stock or fallback) --------
  const selectedVariant =
    singleData.variants.find(v => v.stock > 0) || singleData.variants[0];

  const productOffer = singleData.offerPercentage || 0;
  const categoryOffer = singleData.category?.offerPercentage || 0;
  const bestOffer = Math.max(productOffer, categoryOffer);

  const finalPrice =
    selectedVariant.price - (selectedVariant.price * bestOffer / 100);
%>

<main class="main">
  <div class="page-content">
    <div class="container">

      <div class="product-details-top mb-2">
        <div class="row">

          <!-- ================= LEFT : IMAGES ================= -->
          <div class="col-md-6">
            <div class="product-gallery">

              <figure class="product-main-image">
                <img id="productImage"
                     style="height:52rem;width:45rem"
                     src="<%= selectedVariant.images?.[0] || '/images/placeholder.png' %>"
                     alt="product image">

                <a href="#" class="btn-product-gallery">
                  <i class="icon-arrows"></i>
                </a>
              </figure>

              <div class="product-image-gallery">
                <% selectedVariant.images.forEach(img => { %>
                  <a class="product-gallery-item"
                     href="#"
                     onclick="changeImage('<%= img %>')">
                    <img src="<%= img %>" alt="product image">
                  </a>
                <% }) %>
              </div>

            </div>
          </div>

          <!-- ================= RIGHT : DETAILS ================= -->
          <div class="col-md-6">
            <div class="product-details">

              <h3><%= singleData.product_name %></h3>
                 <h5>Brand: <%= singleData.brand %></h5>
              <!-- PRICE -->
              <div class="product-price " id="selectedVariantPrice">
                <% if (bestOffer > 0) { %>
                  <del>₹ <%= selectedVariant.price %></del>
                  <span style="color:#c69c61;">
                    ₹ <%= Math.round(finalPrice) %>
                  </span>
                <% } else { %>
                    
                    <span style="color:#c69c61;">
                      Price: ₹<%= selectedVariant.price %>
                    </span>
                  
                <% } %>
              </div>

             

              <div class="product-content">
                <p><%= singleData.description %></p>
              </div>

              <!-- ================= VARIANTS ================= -->
             <div class="row mt-4">
        <div class="col-12">
          <h5>Select Variant</h5>
          <div style="display:flex;gap:15px;flex-wrap:wrap;">
            <% singleData.variants.forEach((v, idx) => { %>
              <div class="card variant-card"
                   style="width:12rem; position:relative; border:1px solid #ccc; padding:0.5rem;">
                
                <!-- Checkbox top-right -->
                <input type="checkbox"
       class="variant-checkbox"
       id="variantCheck<%= idx %>"
       style="position:absolute; top:5px; right:5px;"
       onchange="selectVariantCard('<%= idx %>')"
       <%= v.stock === 0 ? 'disabled' : '' %>>

                <!-- Variant Image -->
                <img src="<%= v.images?.[0] || '/images/placeholder.png' %>"
                     alt="variant image"
                     style="width:100%; height:10rem; object-fit:cover;">

                <!-- Variant Details -->
                <div style="padding:0.5rem;">
                  <p>Size: <%= v.size %></p>
                  <p>Color: <%= v.color %></p>
                  <% const variantOffer = Math.max(singleData.offerPercentage || 0, singleData.category?.offerPercentage || 0) %>
                  <% const finalPrice = v.price - (v.price * variantOffer / 100) %>
                  <% if (variantOffer>0) { %>
                    <p>Price: <del>₹<%= v.price %></del> ₹<%= Math.round(finalPrice) %></p>
                    <p style="color:#c69c61;">Offer: <%= variantOffer %>%</p>
                  <% } else { %>
                    <p>Price: ₹<%= v.price %></p>
                  <% } %>
                  <p>Stock: <%= v.stock > 0 ? 'In Stock' : 'Out of Stock' %></p>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>
              <br>
           
              <div class="details-filter-row">
                <h6 id="selectedVariantStock">
                  <%= selectedVariant.stock > 0 ? 'Stock: In Stock' : 'Stock: Out of Stock' %>
                </h6>
              </div>

              <div class="product-details-action disabled">
                <a id="addToCartBtn"
                   href="/cart/add?id=<%= singleData._id %>&variant=<%= selectedVariant._id %>"
                   class="btn-product btn-cart">
                  <span>Add to Cart</span>
                </a>

                &nbsp;&nbsp;

                <a href="/addWishlist?id=<%= singleData._id %>"
                   class="btn-product btn-cart">
                  <span>Add to Wishlist</span>
                </a>
              </div>

              <!-- FOOTER -->
              <div class="product-details-footer">
                <div class="product-cat">
                  <span>Category:</span>
                  <a href="#"><%= singleData.category.name %></a>
                </div>

                <div class="social-icons social-icons-sm">
                  <span class="social-label">Share:</span>
                  <a href="#" class="social-icon"><i class="icon-facebook-f"></i></a>
                  <a href="#" class="social-icon"><i class="icon-twitter"></i></a>
                  <a href="#" class="social-icon"><i class="icon-instagram"></i></a>
                  <a href="#" class="social-icon"><i class="icon-pinterest"></i></a>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</main>

<!-- ================= CLIENT JS ================= -->
<script>
  document.getElementById('addToCartBtn').addEventListener('click', function (e) {
    console.log("its working add to cart");

    const isChecked = Array.from(
        document.querySelectorAll('.variant-checkbox')
    ).some(chk => chk.checked);

    if (!isChecked) {
        e.preventDefault();
			Swal.fire({
            icon: 'warning',
            title: 'Please select a variant before adding to cart',
            confirmButtonText: 'OK'
        });
				
        return;
    }
});

    

    function selectVariantCard(idx) {
    document.querySelectorAll('.variant-checkbox').forEach((chk, i) => {
      if(i !== Number(idx)) chk.checked = false;
    });

    selectedVariantIndex = idx;
    const v = variants[idx];
    if(v.images?.length){
      document.getElementById('productImage').src = v.images[0];
    }

    // Update price
    const finalPrice = v.price - (v.price * bestOffer / 100);
    document.getElementById('selectedVariantPrice').innerHTML =
      bestOffer > 0
        ? `Price: <del>₹${v.price}</del> ₹${Math.round(finalPrice)} (Offer: ${bestOffer}%)`
        : `Price: ₹${v.price}`;

    // Update stock
    document.getElementById('selectedVariantStock').innerText =
      `Stock: ${v.stock > 0 ? 'In Stock' : 'Out of Stock'}`;

    // Update Add to Cart
    const btn = document.getElementById('addToCartBtn');
    if(v.stock > 0){
      btn.href = `/cart/add?id=${productId}&variant=${v._id}`;
      btn.classList.remove('disabled');
      btn.style.pointerEvents = 'auto';
    } else {
      btn.classList.add('disabled');
      btn.style.pointerEvents = 'none';
    }
  }
  function changeImage(img) {
    document.getElementById('productImage').src = img;
  }

  function selectVariant(id, price, stock, size, color, images) {
    document.getElementById('productImage').src =
      images[0] || '/images/placeholder.png';

    document.getElementById('stockText').innerText =
      stock > 0 ? 'In Stock' : 'Out of Stock';

    document.getElementById('addToCartBtn').href =
      `/cart/add?id=<%= singleData._id %>&variant=${id}`;
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<%- include('../layouts/userfooter') %>
